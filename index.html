<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>吃飽沒測試掃描器</title>

<style>
*{ box-sizing:border-box; }

:root{
  --bg:#071821;
  --panel:#06131a;
  --text:#dff6ff;
  --muted:rgba(223,246,255,.72);
  --accent:#3bdcff;
  --accentText:#002733;
  --glow:rgba(59,220,255,.35);
  --grid:rgba(223,246,255,.06);
}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Noto Sans TC",sans-serif;
  text-align:center;
  transition: background .25s ease;
  overflow-x:hidden;
}

/* 科技網格 + 雜訊 */
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:
    linear-gradient(var(--grid) 1px, transparent 1px),
    linear-gradient(90deg, var(--grid) 1px, transparent 1px),
    radial-gradient(circle at 20% 15%, rgba(255,255,255,0.04), transparent 55%),
    radial-gradient(circle at 80% 35%, rgba(255,255,255,0.03), transparent 60%);
  background-size: 34px 34px, 34px 34px, auto, auto;
  pointer-events:none;
  opacity:.75;
}
body::after{
  content:"";
  position:fixed;
  inset:0;
  background: repeating-linear-gradient(
    to bottom,
    rgba(255,255,255,0.03) 0px,
    rgba(255,255,255,0.03) 1px,
    transparent 2px,
    transparent 6px
  );
  mix-blend-mode: overlay;
  opacity:.12;
  pointer-events:none;
}

/* 主題色 */
.theme-blue{
  --bg:#071821; --panel:#06131a;
  --accent:#3bdcff; --accentText:#002733;
  --glow:rgba(59,220,255,.35);
  --grid:rgba(223,246,255,.06);
}
.theme-green{
  --bg:#051b12; --panel:#04140d;
  --accent:#00ff88; --accentText:#002b19;
  --glow:rgba(0,255,136,.35);
  --grid:rgba(223,246,255,.06);
}
/* ✅ 新增：紫色（給「幾乎沒吃」象限） */
.theme-purple{
  --bg:#120a24; --panel:#0c0619;
  --accent:#b783ff; --accentText:#1b0033;
  --glow:rgba(183,131,255,.35);
  --grid:rgba(223,246,255,.05);
}
.theme-yellow{
  --bg:#1a1606; --panel:#141104;
  --accent:#ffe066; --accentText:#2b2400;
  --glow:rgba(255,224,102,.35);
  --grid:rgba(223,246,255,.06);
}
.theme-red{
  --bg:#1b0707; --panel:#140505;
  --accent:#ff4d4d; --accentText:#2b0000;
  --glow:rgba(255,77,77,.35);
  --grid:rgba(223,246,255,.06);
}

header{
  padding:16px 10px 10px;
  border-bottom:1px solid rgba(255,255,255,0.08);
}
#appTitle{
  font-size:22px;
  font-weight:900;
  letter-spacing:1.5px;
}
#subtitle{
  margin-top:6px;
  font-size:12px;
  letter-spacing:.8px;
  color:var(--muted);
  text-transform:uppercase;
}

#wrap{
  max-width:420px;
  margin:0 auto;
  padding: 10px 12px 20px;
}

/* Scanner */
#scanner{
  width: 340px;
  height: 560px;
  margin: 10px auto 10px;
  border-radius: 28px;
  border: 2px solid var(--accent);
  position: relative;
  background: radial-gradient(circle at center, rgba(255,255,255,0.06), rgba(0,0,0,0.95));
  overflow:hidden;
  box-shadow: 0 0 0 2px rgba(255,255,255,0.02), 0 20px 60px rgba(0,0,0,0.52);
  transition:border-color .25s ease;
}

/* 角落框 */
#scannerCorners{
  position:absolute;
  inset:12px;
  border-radius:20px;
  border:1px solid rgba(255,255,255,0.10);
  pointer-events:none;
}
#scannerCorners::before, #scannerCorners::after{
  content:"";
  position:absolute;
  width:16px; height:16px;
  border:2px solid color-mix(in oklab, var(--accent) 80%, white 20%);
  opacity:.9;
}
#scannerCorners::before{ left:8px; top:8px; border-right:none; border-bottom:none; }
#scannerCorners::after{ right:8px; bottom:8px; border-left:none; border-top:none; }

/* 人體輪廓 */
#body{
  position:absolute;
  top:104px; left:50%;
  transform:translateX(-50%);
  width:195px; height:300px;
  border-radius:100px;
  border:2px dashed rgba(223,246,255,0.30);
}

/* 胃部：外框 */
#stomach{
  position:absolute;
  bottom:108px; left:50%;
  transform:translateX(-50%);
  width:140px; height:190px;
  border-radius:70px;
  border:1px solid rgba(223,246,255,0.18);
  background: rgba(0,0,0,0.15);
  overflow:hidden;
  filter: drop-shadow(0 0 18px var(--glow));
  transition: filter .25s ease, border-color .25s ease;
}
/* 胃部：填滿層（百分比連動） */
#fill{
  position:absolute;
  left:0; right:0;
  bottom:0;
  height: 0%;
  background: linear-gradient(
    to top,
    color-mix(in oklab, var(--accent) 55%, transparent),
    color-mix(in oklab, var(--accent) 25%, transparent)
  );
  box-shadow: inset 0 0 18px var(--glow);
  transition: height .55s ease;
}
/* 胃部：微微光暈 */
#fillGlow{
  position:absolute;
  left:-20%;
  width:140%;
  height:46px;
  top:-10px;
  background: radial-gradient(circle, rgba(255,255,255,0.10), transparent 70%);
  opacity:.55;
  animation: glowDrift 3.8s ease-in-out infinite;
  pointer-events:none;
}
@keyframes glowDrift{
  0%,100%{ transform: translateX(-6%); opacity:.45; }
  50%{ transform: translateX(6%); opacity:.75; }
}

/* 掃描線 */
#scanline{
  position:absolute;
  top:-60px; left:0;
  width:100%; height:38px;
  background:linear-gradient(to bottom, transparent, color-mix(in oklab, var(--accent) 95%, white 5%), transparent);
  opacity:0;
  filter: blur(.2px);
}
.scanning #scanline{
  opacity:1;
  animation:scan linear;
}
@keyframes scan{
  from{ top:-60px; }
  to{ top:640px; }
}

/* HUD */
#hudLayer{
  position:absolute;
  inset:0;
  pointer-events:none;
}

/* 上方狀態列 */
#hudTopBar{
  position:absolute;
  left:14px; right:14px; top:12px;
  display:flex;
  justify-content:space-between;
  gap:10px;
  font-size:11px;
  color:rgba(223,246,255,.75);
  letter-spacing:.6px;
  text-transform:uppercase;
}
#hudTopBar b{
  color: color-mix(in oklab, var(--accent) 70%, white 30%);
  font-variant-numeric:tabular-nums;
}

/* 進度條 */
#progressWrap{
  position:absolute;
  left:18px; right:18px;
  top:44px;
  height:10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.06);
  overflow:hidden;
}
#progressBar{
  height:100%;
  width:0%;
  background: color-mix(in oklab, var(--accent) 80%, white 20%);
  box-shadow: 0 0 18px var(--glow);
  transition: width .12s linear;
}

/* 左右數據（整齊排列） */
#sideStats{
  position:absolute;
  left:16px; right:16px;
  top:78px;
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.statCol{
  width: 132px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.hudChip{
  display:flex;
  justify-content:space-between;
  align-items:baseline;
  padding:7px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.10);
  background: rgba(0,0,0,0.35);
  font-size:11px;
  color:rgba(223,246,255,.78);
  letter-spacing:.6px;
  text-transform:uppercase;
  backdrop-filter: blur(2px);
  box-shadow: 0 8px 24px rgba(0,0,0,.32);
}
.hudChip b{
  color: color-mix(in oklab, var(--accent) 70%, white 30%);
  font-variant-numeric: tabular-nums;
}

/* 細線（克制） */
.hudLine{
  position:absolute;
  height:1px;
  background: linear-gradient(90deg, transparent, color-mix(in oklab, var(--accent) 65%, white 35%), transparent);
  opacity:.26;
  filter: drop-shadow(0 0 10px var(--glow));
  animation: flicker 3.2s ease-in-out infinite;
}
@keyframes flicker{
  0%,100%{ opacity:.18; }
  45%{ opacity:.34; }
  70%{ opacity:.22; }
}
#line1{ left:26px; top:172px; width:260px; }
#line2{ left:42px; top:320px; width:220px; }
#line3{ left:32px; top:368px; width:250px; }

/* Target lock */
#lockTag{
  position:absolute;
  right:16px;
  bottom:222px;
  font-size:11px;
  letter-spacing:1px;
  text-transform:uppercase;
  color: rgba(223,246,255,.70);
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.12);
  background: rgba(0,0,0,0.35);
}
.scanning #lockTag{ animation: lockblink 0.9s ease-in-out infinite; }
@keyframes lockblink{
  0%,100%{ opacity:.35; }
  50%{ opacity:1; }
}
.hold #lockTag{
  color: color-mix(in oklab, var(--accent) 65%, white 35%);
  border-color: rgba(255,255,255,0.16);
}

/* 大 % */
#bigPct{
  position:absolute;
  left:0; right:0;
  bottom:154px;
  font-size:86px;
  font-weight:950;
  letter-spacing:1px;
  color:var(--accent);
  text-shadow: 0 0 34px var(--glow);
  line-height:1;
}

/* 狀態 & 建議 */
#hudState{
  position:absolute;
  left:18px; right:18px;
  bottom:78px;
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:12px;
}
#stateTitle{
  text-align:left;
  font-size:13px;
  letter-spacing:1px;
  color:rgba(223,246,255,.75);
}
#stateTitle strong{
  display:block;
  font-size:16px;
  color: color-mix(in oklab, var(--accent) 65%, white 35%);
  margin-top:6px;
  letter-spacing:.6px;
}
#advice{
  text-align:right;
  font-size:18px;
  font-weight:900;
  color: color-mix(in oklab, var(--accent) 70%, white 30%);
  text-shadow: 0 0 18px var(--glow);
}

/* % 彈一下 */
.pop{ animation: pop .58s ease; }
@keyframes pop{
  0%{ transform:translateY(10px) scale(.96); opacity:.65; }
  55%{ transform:translateY(-10px) scale(1.04); opacity:1; }
  100%{ transform:translateY(0) scale(1); opacity:1; }
}

/* 掃描 LOG */
#scanLog{
  position:absolute;
  left:18px; right:18px;
  bottom:16px;
  height:44px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.10);
  background: rgba(0,0,0,0.30);
  padding:8px 10px;
  display:flex;
  align-items:center;
  gap:10px;
  overflow:hidden;
}
#scanDot{
  width:10px; height:10px;
  border-radius:50%;
  background: color-mix(in oklab, var(--accent) 80%, white 20%);
  box-shadow: 0 0 18px var(--glow);
  opacity:.55;
}
.scanning #scanDot{ animation: dotpulse 0.9s ease-in-out infinite; }
@keyframes dotpulse{
  0%,100%{ transform:scale(.85); opacity:.35; }
  50%{ transform:scale(1.2); opacity:1; }
}
#scanMsg{
  font-size:11px;
  letter-spacing:.6px;
  color: rgba(223,246,255,.72);
  text-transform:uppercase;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.hold #scanMsg{
  color: color-mix(in oklab, var(--accent) 55%, white 45%);
}

/* 角落小波形（SVG） */
#waveWrap{
  position:absolute;
  left:16px;
  bottom:222px;
  width:120px;
  height:44px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.10);
  background: rgba(0,0,0,0.30);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
#wave{
  width:104px;
  height:28px;
}
#wave path{
  stroke: color-mix(in oklab, var(--accent) 70%, white 30%);
  stroke-width:2;
  fill:none;
  opacity:.85;
}
.scanning #wave path{ animation: waveMove 1.1s linear infinite; }
@keyframes waveMove{
  from{ transform: translateX(0px); }
  to{ transform: translateX(-18px); }
}

/* 指引疊圖（不提手電筒） */
#instructionOverlay{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(0,0,0,0.22);
  backdrop-filter: blur(2px);
  z-index: 6;
  transition: opacity .35s ease;
}
#instructionOverlay.hide{
  opacity:0;
  pointer-events:none;
}
.instructionBox{
  padding:20px 22px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,0.18);
  background: color-mix(in oklab, rgba(0,0,0,0.62) 72%, transparent);
  box-shadow: 0 0 44px var(--glow);
  text-align:center;
  width: 78%;
  max-width: 280px;
}
.instructionTitle{
  font-size:13px;
  letter-spacing:2px;
  margin-bottom:10px;
  color: color-mix(in oklab, var(--accent) 65%, white 35%);
  text-transform:uppercase;
}
.instructionText{
  font-size:15px;
  line-height:1.65;
  letter-spacing:.4px;
  color: rgba(223,246,255,.92);
}

/* 按鈕（20/40/30/10） */
#bigBtnWrap{
  width: 340px;
  margin: 10px auto 0;
  position:relative;
}
#bigBtn{
  width:100%;
  height:86px;
  border:none;
  border-radius:22px;
  background:var(--accent);
  color:var(--accentText);
  font-size:26px;
  font-weight:900;
  letter-spacing:1.5px;
  box-shadow:0 18px 48px rgba(0,0,0,0.38), 0 0 36px var(--glow);
  transition: background .25s ease, color .25s ease, box-shadow .25s ease;
}
#bigBtn[aria-disabled="true"]{ opacity:.45; }

.zone{
  position:absolute;
  top:0; height:86px;
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
  background:rgba(0,0,0,0);
}
#zoneHungry{ left:0;  width:20%; border-radius:22px 0 0 22px; }
#zoneGreen{  left:20%; width:40%; }
#zoneYellow{ left:60%; width:30%; }
#zoneRed{    left:90%; width:10%; border-radius:0 22px 22px 0; }

/* 重置按鈕（單純保留） */
#resetBtn{
  margin:10px auto 0;
  padding:10px 22px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.25);
  background:rgba(0,0,0,0.35);
  color:rgba(223,246,255,0.85);
  font-size:14px;
  letter-spacing:2px;
  backdrop-filter: blur(2px);
  box-shadow:0 0 18px rgba(0,0,0,0.4);
  display:inline-flex;
  align-items:center;
  user-select:none;
  -webkit-user-select:none;
}
#resetBtn:active{ transform: scale(.96); }
</style>
</head>

<body class="theme-blue">
<header>
  <div id="appTitle">吃飽沒測試掃描器</div>
  <div id="subtitle">SATIETY · XRAY · DIAGNOSTIC · MODULE</div>
</header>

<div id="wrap">

  <div id="scanner">
    <div id="scanline"></div>
    <div id="scannerCorners"></div>
    <div id="body"></div>

    <div id="stomach">
      <div id="fill"><div id="fillGlow"></div></div>
    </div>

    <div id="hudLayer">
      <div id="hudTopBar">
        <span>MODE:<b id="mode">IDLE</b></span>
        <span>SIG:<b id="sig">--</b>%</span>
        <span>NOI:<b id="noi">--</b>dB</span>
        <span>TEMP:<b id="temp">--</b>°C</span>
      </div>

      <div id="progressWrap"><div id="progressBar"></div></div>

      <div id="sideStats">
        <div class="statCol">
          <div class="hudChip"><span>LAT</span><b id="lat">--</b></div>
          <div class="hudChip"><span>BUF</span><b id="buf">--</b></div>
        </div>
        <div class="statCol">
          <div class="hudChip"><span>IDX</span><b id="idx">--</b></div>
          <div class="hudChip"><span>CRC</span><b id="crc">----</b></div>
        </div>
      </div>

      <div class="hudLine" id="line1"></div>
      <div class="hudLine" id="line2"></div>
      <div class="hudLine" id="line3"></div>

      <div id="waveWrap">
        <svg id="wave" viewBox="0 0 120 30" xmlns="http://www.w3.org/2000/svg" aria-label="waveform">
          <path d="M0 15 C10 5, 20 25, 30 15 C40 5, 50 25, 60 15 C70 5, 80 25, 90 15 C100 5, 110 25, 120 15"/>
        </svg>
      </div>

      <div id="lockTag">TARGET · LOCK</div>

      <div id="bigPct">--%</div>

      <div id="hudState">
        <div id="stateTitle">
          狀態
          <strong id="stateStrong">待機</strong>
        </div>
        <div id="advice">—</div>
      </div>

      <div id="scanLog">
        <div id="scanDot"></div>
        <div id="scanMsg">SYSTEM READY · AWAIT INPUT</div>
      </div>
    </div>

    <div id="instructionOverlay">
      <div class="instructionBox">
        <div class="instructionTitle">SCAN PREP</div>
        <div class="instructionText">
          請將<strong>食指</strong>放置於<br>
          任一顆鏡頭前方，<br>
          並保持不動，<br>
          系統將開始進行掃描。
        </div>
      </div>
    </div>

  </div>

  <div id="bigBtnWrap">
    <button id="bigBtn" aria-disabled="false">開始掃描</button>
    <div id="zoneHungry" class="zone" role="button" aria-label="掃描（幾乎沒吃）"></div>
    <div id="zoneGreen"  class="zone" role="button" aria-label="掃描（還可以吃很多）"></div>
    <div id="zoneYellow" class="zone" role="button" aria-label="掃描（快吃飽）"></div>
    <div id="zoneRed"    class="zone" role="button" aria-label="掃描（已吃飽）"></div>
  </div>

  <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-top:10px;">
    <button id="resetBtn" aria-label="重置">重置</button>
  </div>

</div>

<script>
const scanner  = document.getElementById("scanner");
const scanline = document.getElementById("scanline");
const bigBtn   = document.getElementById("bigBtn");

const bigPct = document.getElementById("bigPct");
const modeEl = document.getElementById("mode");
const sigEl  = document.getElementById("sig");
const noiEl  = document.getElementById("noi");
const tempEl = document.getElementById("temp");

const stateStrong = document.getElementById("stateStrong");
const adviceEl = document.getElementById("advice");

const latEl = document.getElementById("lat");
const bufEl = document.getElementById("buf");
const idxEl = document.getElementById("idx");
const crcEl = document.getElementById("crc");

const overlay = document.getElementById("instructionOverlay");
const progressBar = document.getElementById("progressBar");
const scanMsg = document.getElementById("scanMsg");
const fillEl = document.getElementById("fill");

const zoneHungry = document.getElementById("zoneHungry");
const zoneGreen  = document.getElementById("zoneGreen");
const zoneYellow = document.getElementById("zoneYellow");
const zoneRed    = document.getElementById("zoneRed");

const resetBtn = document.getElementById("resetBtn");

let isScanning = false;
let hudTimer = null;
let progressTimer = null;
let logTimer = null;
let stomachTimer = null;

/* ✅ 控制：重置後第一次掃描偏保守、連續掃描提示 */
let lastScanAt = 0;
let isFirstAfterReset = true;

function randInt(min, max){
  return Math.floor(Math.random() * (max - min + 1)) + min;
}
function randHex(){
  return randInt(4096, 65535).toString(16).toUpperCase();
}
function setTheme(theme){ document.body.className = theme; }

function setDisabled(disabled){
  bigBtn.setAttribute("aria-disabled", disabled ? "true" : "false");
  const pe = disabled ? "none" : "auto";
  zoneHungry.style.pointerEvents = pe;
  zoneGreen.style.pointerEvents  = pe;
  zoneYellow.style.pointerEvents = pe;
  zoneRed.style.pointerEvents    = pe;
}

function setScannerState(scanning, hold){
  scanner.classList.toggle("scanning", scanning);
  scanner.classList.toggle("hold", hold);
}

/* % 彈跳 */
function animatePercent(toValue){
  const fromValue = Math.max(0, toValue - randInt(14, 32));
  const duration = 720;
  const start = performance.now();

  bigPct.classList.remove("pop");
  void bigPct.offsetWidth;
  bigPct.classList.add("pop");

  function tick(now){
    const t = Math.min(1, (now - start) / duration);
    const eased = 1 - Math.pow(1 - t, 3);
    const current = Math.round(fromValue + (toValue - fromValue) * eased);
    bigPct.textContent = current + "%";
    if(t < 1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

/* HUD 數字（克制、只變數值） */
function startHUD(fast){
  if(hudTimer) clearInterval(hudTimer);
  const interval = fast ? 280 : 980;
  hudTimer = setInterval(() => {
    sigEl.textContent  = randInt(72, 99);
    noiEl.textContent  = randInt(3, 18);
    tempEl.textContent = (Math.random() * (36.9 - 33.0) + 33.0).toFixed(1);

    latEl.textContent  = randInt(6, 22);
    bufEl.textContent  = randInt(40, 96);
    idxEl.textContent  = randInt(120, 999);
    crcEl.textContent  = randHex();
  }, interval);
}

/* 進度條 */
function startProgress(scanTime){
  if(progressTimer) clearInterval(progressTimer);
  const start = performance.now();
  progressBar.style.width = "0%";
  progressTimer = setInterval(() => {
    const t = Math.min(1, (performance.now() - start) / scanTime);
    const pct = Math.round(t * 100);
    progressBar.style.width = pct + "%";
    if(t >= 1){
      clearInterval(progressTimer);
      progressTimer = null;
    }
  }, 60);
}

/* 掃描 LOG */
const scanLogsBase = [
  "CALIBRATION · LENS ALIGN",
  "VALIDATION · SENSOR SYNC",
  "CRC CHECK · FRAME INTEGRITY",
  "NOISE FILTER · STABILIZE",
  "THERMAL NORMALIZE",
  "SATIETY MODEL · INFERENCE",
  "RESULT COMPOSE · FINALIZE"
];

function startLog(isRescan){
  stopLog();
  const logs = isRescan
    ? ["RE-SCAN · CONFIRM SIGNAL", ...scanLogsBase]
    : scanLogsBase.slice();

  let i = 0;
  scanMsg.textContent = logs[0];
  logTimer = setInterval(() => {
    i = Math.min(logs.length - 1, i + 1);
    scanMsg.textContent = logs[i];
  }, 650);
}
function stopLog(){
  if(logTimer) clearInterval(logTimer);
  logTimer = null;
}

/* 胃部連動：掃描中慢慢爬升，最後鎖定結果 */
function setStomachFill(percent){
  const h = Math.max(0, Math.min(92, Math.round(percent * 0.92)));
  fillEl.style.height = h + "%";
}
function startStomachDuringScan(scanTime){
  if(stomachTimer) clearInterval(stomachTimer);
  const start = performance.now();
  stomachTimer = setInterval(() => {
    const t = Math.min(1, (performance.now() - start) / scanTime);
    const pseudo = Math.round(70 * t);
    setStomachFill(pseudo);
    if(t >= 1){
      clearInterval(stomachTimer);
      stomachTimer = null;
    }
  }, 90);
}
function stopStomachTimer(){
  if(stomachTimer) clearInterval(stomachTimer);
  stomachTimer = null;
}

/* 震動 + 嗶 */
function feedbackComplete(){
  try{ navigator.vibrate?.(20); }catch(e){}
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.value = 880;
    g.gain.value = 0.06;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 90);
  }catch(e){}
}

/* 文案：口數 */
function bitesText(min,max){
  const n = randInt(min,max);
  return `還可以再吃 ${n} 口`;
}

/* 結果產生（保留四區邏輯）+ 重置後第一次偏保守 */
function resolveOutcome(mode){
  const conservative = isFirstAfterReset;

  if(mode === "hungry"){ // 20-35
    const fullness = conservative ? randInt(20, 30) : randInt(20, 35);
    const msg = (fullness <= 30)
      ? "才剛開始吃｜還可以吃很多口"
      : "進食量偏低｜還可以吃很多口";
    /* ✅ 只改這裡：幾乎沒吃 -> 紫色 */
    return { fullness, themeAfter:"theme-purple", stateAfter:"幾乎沒吃", adviceAfter: msg };
  }

  if(mode === "green"){ // 60-72（偏保守 58-70）
    const fullness = conservative ? randInt(58, 70) : randInt(60, 72);
    return { fullness, themeAfter:"theme-green", stateAfter:"還可以吃很多", adviceAfter: bitesText(8,12) };
  }

  if(mode === "yellow"){ // 73-90（偏保守 72-86）
    const fullness = conservative ? randInt(72, 86) : randInt(73, 90);
    return { fullness, themeAfter:"theme-yellow", stateAfter:"快吃飽", adviceAfter: bitesText(2,4) };
  }

  // red：91-98（正常可出）
  const fullness = conservative ? randInt(90, 96) : randInt(91, 98);
  return { fullness, themeAfter:"theme-red", stateAfter:"已吃飽", adviceAfter:"停止進食" };
}

/* 掃描主流程 */
function startScan(mode){
  if(isScanning) return;
  isScanning = true;

  overlay?.classList.add("hide");

  const now = Date.now();
  const isRescan = (now - lastScanAt) < 25000; // 25 秒內算連續掃描
  lastScanAt = now;

  const scanTime = randInt(4200, 5600);
  scanline.style.animationDuration = scanTime + "ms";

  setTheme("theme-blue");
  setDisabled(true);
  setScannerState(true, false);

  modeEl.textContent = "SCAN";
  stateStrong.textContent = isRescan ? "再次掃描中" : "掃描中";
  adviceEl.textContent = "分析中…";
  bigPct.textContent = "--%";
  setStomachFill(0);

  startHUD(true);
  startProgress(scanTime);
  startLog(isRescan);
  startStomachDuringScan(scanTime);

  const out = resolveOutcome(mode);

  setTimeout(() => {
    setScannerState(false, true);
    stopLog();
    stopStomachTimer();

    setTheme(out.themeAfter);
    modeEl.textContent = "HOLD";
    stateStrong.textContent = out.stateAfter;
    adviceEl.textContent = out.adviceAfter;

    animatePercent(out.fullness);
    setStomachFill(out.fullness);

    const extra = isRescan ? " · CONFIRMED" : "";
    scanMsg.textContent = "COMPLETE · RESULT LOCKED" + extra;

    startHUD(false);
    feedbackComplete();

    isFirstAfterReset = false;

    isScanning = false;
    setDisabled(false);
  }, scanTime);
}

/* 四區點擊 */
zoneHungry.addEventListener("click", () => startScan("hungry"));
zoneGreen.addEventListener("click",  () => startScan("green"));
zoneYellow.addEventListener("click", () => startScan("yellow"));
zoneRed.addEventListener("click",    () => startScan("red"));

/* 點大按鈕走綠 */
bigBtn.addEventListener("click", () => {
  if(bigBtn.getAttribute("aria-disabled") === "true") return;
  startScan("green");
});

/* 重置 */
function resetScanner(){
  if(hudTimer) clearInterval(hudTimer);
  if(progressTimer) clearInterval(progressTimer);
  if(logTimer) clearInterval(logTimer);
  if(stomachTimer) clearInterval(stomachTimer);
  hudTimer = progressTimer = logTimer = stomachTimer = null;

  isScanning = false;
  setTheme("theme-blue");
  setScannerState(false, false);
  setDisabled(false);

  bigPct.textContent = "--%";
  stateStrong.textContent = "待機";
  adviceEl.textContent = "—";
  modeEl.textContent = "IDLE";

  scanMsg.textContent = "SYSTEM READY · AWAIT INPUT";
  progressBar.style.width = "0%";
  setStomachFill(0);

  overlay.classList.remove("hide");

  // 重置後第一次掃描偏保守（更容易顯示還可以吃）
  isFirstAfterReset = true;

  startHUD(false);
}

resetBtn.addEventListener("click", resetScanner);

/* 初始 */
startHUD(false);
setStomachFill(0);
</script>

</body>
</html>
